{% extends 'base.html' %}
{% load crispy_forms_filters %}
{% load static %}
{% load crispy_forms_tags %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/custom.css' %}">
{% endblock %}

{% block title %}Purchase Entry{% endblock %}

{% block content %}
<div class="container-fluid mt-5">
    <h2 class="text-center">Purchase Entry</h2>
    <form method="post" class="mt-3">
        {% csrf_token %}
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="supplier-select" id="hide-me">Supplier</label>
                {{ form.supplier_name|as_crispy_field }}
                <div id="hide-me">
                <select id="supplier-select">
                    <!-- Options for suppliers will be populated by JavaScript -->
                </select>
           </div>
            </div>
            <div class="col-md-6">
                <label for="supplier-gstin">Supplier GSTIN</label><br>
                <input type="text" id="supplier-gstin" class="col-md-3" readonly>
            </div>
        </div>

        <!-- Purchase Details -->
        <div class="row mb-3">
            <div class="col-md-3">
                {{ form.purchase_type|as_crispy_field }}
            </div>
            <div class="col-md-3">
                {{ form.invoice_number|as_crispy_field }}
            </div>
            <div class="col-md-3">
                {{ form.invoice_date|as_crispy_field }}
            </div>
            <div class="col-md-3">
                {{ form.invoice_discount|as_crispy_field }}
            </div>
        </div>
        
        <!-- Items Section -->
        <h3 class="mt-4">Items</h3>
        <div id="purchase-items">
            {{ formset.management_form }}
            <table class="table table-dark table-striped table-hover shadow">
                <thead>
                    <tr>
                        <th style="width:30%;">Item</th>
                        <th style="width:7%;">MRP</th>
                        <th style="width:5%;">Quantity</th>
                        <th style="width:5%;">Free</th>
                        <th style="width:15%;">Batch Number</th>
                        <th style="width:10%;">Expiry Date</th>
                        <th style="width:7%;">Purchase Rate</th>
                        <th style="width:5%;">Discount %</th>
                        <th style="width:7%;">Discount Amount</th>
                        <th style="width:5%;">GST</th>
                        <th style="width:4%;">Action</th>
                    </tr>
                </thead>
                <tbody class="no-label-in-table">
                    {% for form in formset %}
                    <tr>
                        <td style="width:30%;">{{ form.item|as_crispy_field }}</td>
                        <td style="width:7%;">{{ form.mrp|as_crispy_field }}</td>
                        <td style="width:5%;">{{ form.quantity|as_crispy_field }}</td>
                        <td style="width:5%;">{{ form.free|as_crispy_field }}</td>
                        <td style="width:15%;">{{ form.batch_number|as_crispy_field }}</td>
                        <td style="width:10%;">{{ form.expiry_date|as_crispy_field }}</td>
                        <td style="width:7%;">{{ form.purchase_rate|as_crispy_field }}</td>
                        <td style="width:5%;">{{ form.item_discount_percentage|as_crispy_field }}</td>
                        <td style="width:7%;">{{ form.item_discount_amount|as_crispy_field }}</td>
                        <td style="width:5%;"><input type="text" class="form-control gst-field" readonly></td>
                        <td style="width:4%;"><button type="button" class="btn btn-danger remove-item">Remove</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <button type="button" class="btn btn-primary" id="add-item">Add Item</button>
        <div class="text-center mt-4">
            <button type="submit" class="btn btn-success btn-lg">Submit</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const addItemButton = document.getElementById('add-item');
    const purchaseItemsContainer = document.getElementById('purchase-items');
    const totalForms = document.querySelector('#id_form-TOTAL_FORMS');
    const formRegex = RegExp(`form-(\\d{1})-`, 'g');

    function fetchItems() {
        return fetch('/item/get_items/')
            .then(response => response.json())
            .then(data => data.items);
    }

    function createItemOptions(items) {
        return items.map(item => `<option value="${item.id}">${item.name}</option>`).join('');
    }

    function addNewRow(items) {
        const newForm = document.createElement('tr');
        newForm.innerHTML = `
            <td style="width:30%;"><div class="item"><select name="form-${totalForms.value}-item" class="form-control">${createItemOptions(items)}</select></div></td>
            <td style="width:7%;"><input type="text" name="form-${totalForms.value}-mrp" class="form-control"></td>
            <td style="width:5%;"><input type="text" name="form-${totalForms.value}-quantity" class="form-control"></td>
            <td style="width:5%;"><input type="text" name="form-${totalForms.value}-free" class="form-control"></td>
            <td style="width:15%;"><input type="text" name="form-${totalForms.value}-batch_number" class="form-control"></td>
            <td style="width:10%;"><input type="text" name="form-${totalForms.value}-expiry_date" class="form-control"></td>
            <td style="width:7%;"><input type="text" name="form-${totalForms.value}-purchase_rate" class="form-control"></td>
            <td style="width:5%;"><input type="text" name="form-${totalForms.value}-item_discount_percentage" class="form-control"></td>
            <td style="width:7%;"><input type="text" name="form-${totalForms.value}-item_discount_amount" class="form-control"></td>
            <td style="width:5%;"><input type="text" class="form-control gst-field" readonly></td>
            <td style="width:4%;"><button type="button" class="btn btn-danger remove-item">Remove</button></td>
        `;
        purchaseItemsContainer.querySelector('tbody').appendChild(newForm);
        totalForms.value = parseInt(totalForms.value) + 1;
    }

    fetchItems().then(items => {
        // Initially add five new rows
        for (let i = 0; i < 5; i++) {
            addNewRow(items);
        }

        addItemButton.addEventListener('click', function () {
            addNewRow(items);
        });
    });

    purchaseItemsContainer.addEventListener('change', function (event) {
        if (event.target.name.includes('item')) {
            const formIndex = event.target.name.match(/\d+/)[0];
            const gstField = event.target.closest('tr').querySelector(`[name="form-${formIndex}-gst"]`);
            const itemId = event.target.value;

            fetch(`/item/get_item_gst/${itemId}/`)
                .then(response => response.json())
                .then(data => {
                    gstField.value = data.gst;
                })
                .catch(error => console.error('Error fetching GST:', error));
        }
    });

    purchaseItemsContainer.addEventListener('click', function (event) {
        if (event.target.classList.contains('remove-item')) {
            event.target.closest('tr').remove();
            const forms = purchaseItemsContainer.querySelectorAll('tbody tr');
            totalForms.value = forms.length;
            forms.forEach((form, index) => {
                form.innerHTML = form.innerHTML.replace(formRegex, `form-${index}-`);
            });
        }
    });

    // Handling supplier GSTIN
    const supplierSelect = document.getElementById('supplier-select');
    const supplierGstin = document.getElementById('supplier-gstin');

    supplierSelect.addEventListener('change', function () {
        const supplierId = this.value;
        if (supplierId) {
            fetch(`/supplier/get_gstin/${supplierId}/`)
                .then(response => response.json())
                .then(data => {
                    supplierGstin.value = data.gstin;
                })
                .catch(error => console.error('Error fetching GSTIN:', error));
        } else {
            supplierGstin.value = ''; // Clear GSTIN if no supplier is selected
        }
    });

});
</script>
    
    <style>

#hide-me {
    display: none;
}
    </style>
{% endblock %}
